path.data: data
path.logs: log

entry:
  - name: es_gateway #your gateway endpoint
    enabled: true
    router: default
    max_concurrency: 100000
    network:
      binding: 0.0.0.0:8000
      reuse_port: true #you can start multi gateway instance, they share same port, to full utilize system's resources
#    tls:
#      enabled: true #if your es is using https, the gateway entrypoint should enable https too

flow:
  - name: cache_first
    filter: #comment out any filter sections, like you don't need cache or rate-limiter
      - name: get_cache
        parameters:
          pass_patterns:
            - _cat
      - name: date_range_precision_tuning
        parameters:
          time_precision: 4
          path_keywords:
            - _search
            - _async_search
      - name: get_cache
        parameters:
          pass_patterns:
            - _cat
      - name: elasticsearch
        parameters:
          elasticsearch: dev  #elasticsearch configure reference name
          max_connection: 1000 #max tcp connection to upstream, default for all nodes
          max_response_size: -1 #default for all nodes
          balancer: weight
          refresh: # refresh upstream nodes list, need to enable this feature to use elasticsearch nodes auto discovery
            enabled: true
            interval: 30s
#          weights: #overwride host's weight, the default weight is 1
#            - host: 192.168.3.201:9200 #the format is host:port
#              weight: 10
#            - host: 192.168.3.202:9200
#              weight: 20
#            - host: 192.168.3.203:9200
#              weight: 30
#          filter:
#            hosts:
#              exclude: #exclude mode, you may need to filter out master nodes
#                - 192.168.3.201:9200
#              include: #specify endpoints to use, in case of that you may only want to forward traffic to coordinating nodes
#                - 192.168.3.202:9200
#                - 192.168.3.203:9200
#            tags:
#              exclude:
#                - temp: cold
#                - temp: hot
#                - temp: warm
#              include:
#                - disk: sd
#                - disk: sata
#                - disk: ssd
#            roles: # "data","ingest","master","ml","remote_cluster_client","transform"
#              exclude:
#                - master
#              include:
#                - data
#                - ingest
      - name: response_body_regex_replace
        parameters:
          pattern: '"took":\d+,'
          to: '"took":123,'
      - name: set_cache
        parameters:
          cache_ttl: 60s
  - name: online_indexing_merge
    filter:
      - name: bulk_reshuffle
        parameters:
          elasticsearch: dev
          level: node
          mode: async
      - name: elasticsearch
        parameters:
          elasticsearch: dev
          refresh:
            enabled: true
            interval: 30s
  - name: request_logging # this flow is used for request logging, refer to `router`'s `tracing_flow`
    filter:
      - name: request_logging
        parameters:
          queue_name: request_logging
          max_request_body_size: 1024
          max_response_body_size: 1024
router:
  - name: default
    tracing_flow: request_logging
    default_flow: cache_first
    rules:
      - method:
          - "POST"
        pattern:
          - /_bulk
        flow:
          - online_indexing_merge
elasticsearch:
- name: dev
  enabled: true
  endpoint: http://localhost:9200 # if your elasticsearch is using https, your gateway should be listen on as https as well
  basic_auth: #used to discovery full cluster nodes, or check elasticsearch's health and versions
    username: elastic
    password: pass
  discovery: # auto discovery elasticsearch cluster nodes
    enabled: true
    refresh:
      enabled: true
      interval: 30s

modules:
- name: elastic
  enabled: true
  elasticsearch: dev
  store:
    enabled: true
  orm:
    enabled: true
    init_template: true
    template_name: ".gateway-default"
    index_prefix: "gateway_"

- name: pipeline
  enabled: true
  runners:
    - name: primary
      enabled: true
      max_go_routine: 1
      threshold_in_ms: 0
      timeout_in_ms: 5000
      pipeline_id: request_logging_index
    - name: nodes_index
      enabled: true
      max_go_routine: 1
      threshold_in_ms: 0
      timeout_in_ms: 5000
      pipeline_id: bulk_request_ingest


pipelines:
- name: request_logging_index
  start:
    joint: json_indexing
    enabled: true
    parameters:
      index_name: "gateway_requests"
      elasticsearch: "dev"
      input_queue: "request_logging"
      timeout: "1s"
      worker_size: 1
      bulk_size_in_mb: 1 #in MB
- name: bulk_request_ingest
  start:
    joint: bulk_indexing
    enabled: true
    parameters:
      elasticsearch: "dev"
      timeout: "5s"
      worker_size: 1
      bulk_size_in_kb: 1  #in KB
      retry_delay_in_second: 1

#floating_ip:
#  enabled: true
#  ip: 192.168.3.234      #yep, it's optional, infini-gateway could detect one but maybe not the right one
##  netmask: 255.255.255.0 #optional
##  interface: en1         #optional

queue:
  min_msg_size: 1
  max_msg_size: 5000000000
  max_bytes_per_file: 53687091200
  sync_every_records: 100000 # sync by records count
  sync_timeout_in_ms: 1000 # sync by time in million seconds
  write_chan_buffer: 1000
  read_chan_buffer: 1000

statsd:
  enabled: false
  host: 192.168.3.98
  port: 8125
  namespace: gateway.


forcemerge:
  enabled: false
  elasticsearch: dev
  min_num_segments: 1
  max_num_segments: 1
  indices:
    - index_name
